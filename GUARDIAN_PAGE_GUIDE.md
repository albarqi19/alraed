# دليل استخدام صفحة ولي الأمر - طلب النداء الآلي

## 🔗 المسار الرئيسي

```
http://localhost:5173/guardian/leave-request
```

## 📱 كيفية إنشاء طلب نداء

### الطريقة 1: من خلال المتصفح مباشرة

1. **افتح المتصفح وتوجه إلى:**
   ```
   http://localhost:5173/guardian/leave-request
   ```

2. **ستجد واجهة ولي الأمر التي تحتوي على:**
   - بطاقة معلومات الطالب
   - زر "طلب استلام الطالب"
   - معلومات حالة ولي الأمر (إذا كان محظوراً أو لديه مخالفات)

3. **اضغط على زر "طلب استلام الطالب"**
   - سيتم إرسال الطلب إلى Firestore
   - سيظهر الطالب في شاشة العرض فوراً
   - سيظهر أيضاً في صفحة الإدارة

### الطريقة 2: مع معامل URL (لتحديد الطالب)

يمكنك تمرير معلومات الطالب عبر URL:

```
http://localhost:5173/guardian/leave-request?studentId=123
```

أو باستخدام الرقم الوطني للطالب:

```
http://localhost:5173/guardian/leave-request?nationalId=1234567890
```

## 🎯 سيناريو الاستخدام الكامل

### الخطوة 1: افتح صفحة ولي الأمر
```powershell
# في المتصفح
http://localhost:5173/guardian/leave-request
```

### الخطوة 2: افتح شاشة العرض في تبويب آخر
```powershell
# في تبويب ثاني من المتصفح
http://localhost:5173/display/auto-call
```

### الخطوة 3: افتح صفحة الإدارة (اختياري)
```powershell
# في تبويب ثالث
http://localhost:5173/admin/auto-call
```

### الخطوة 4: أنشئ طلب نداء
- من صفحة ولي الأمر، اضغط "طلب استلام الطالب"
- ستلاحظ فوراً:
  - ✅ ظهور الطالب في شاشة العرض
  - ✅ إضافة الطلب في قائمة الانتظار (Queue) في صفحة الإدارة
  - ✅ تغيير حالة الطلب إلى "announcing" إذا كان الأول

## 📋 متطلبات الاستخدام

### 1. يجب أن يكون لديك:
- ✅ Firestore مفعّل ومهيأ (راجع `FIRESTORE_QUICK_START.md`)
- ✅ ملف `.env` يحتوي على متغيرات Firebase
- ✅ معرّف مدرسة محدد (في `.env` أو من تسجيل الدخول)

### 2. البيانات المطلوبة:
الصفحة تحتاج معلومات الطالب وولي الأمر. يمكن أن تأتي من:
- Backend API (إذا كان ولي الأمر مسجل دخول)
- معاملات URL
- بيانات تجريبية افتراضية

## 🧪 بيانات تجريبية للاختبار

إذا لم يكن لديك بيانات حقيقية، يمكن استخدام بيانات تجريبية:

```javascript
// مثال على طالب تجريبي
{
  id: "student_001",
  name: "أحمد محمد علي",
  nationalId: "1234567890",
  class: "الصف الخامس أ",
  guardianName: "محمد علي",
  guardianPhone: "0501234567"
}
```

## 🔍 التحقق من نجاح الطلب

### في Firestore Console:
1. اذهب إلى Firebase Console
2. Firestore Database → Data
3. ابحث عن المسار:
   ```
   schools/school_test_001/autoCallQueue
   ```
4. يجب أن ترى وثيقة جديدة بمعلومات الطلب

### في شاشة العرض:
- يجب أن يظهر اسم الطالب بخط كبير
- معلومات ولي الأمر
- مؤقت العد التنازلي

### في صفحة الإدارة:
- تبويب "Queue" → يجب أن يظهر الطلب
- حالة الطلب: "Announcing" أو "Pending"

## ⚠️ حل المشاكل الشائعة

### المشكلة: لا يظهر شيء بعد الضغط على الزر
**الحلول:**
1. تحقق من Console في المتصفح (F12)
2. تأكد من أن Firestore مفعّل
3. تأكد من قواعد الأمان تسمح بالكتابة
4. تحقق من أن `schoolId` محدد

### المشكلة: خطأ "لا يمكن إنشاء مناداة"
**السبب:** معرّف المدرسة غير محدد

**الحل:**
تأكد من وجود `VITE_AUTO_CALL_FALLBACK_SCHOOL_ID` في ملف `.env`:
```bash
VITE_AUTO_CALL_FALLBACK_SCHOOL_ID=school_test_001
```

### المشكلة: الطلب يظهر في Firestore لكن لا يظهر في الشاشة
**السبب:** مشكلة في الاشتراكات اللحظية

**الحل:**
1. أعد تحميل صفحة العرض
2. تحقق من Console للأخطاء
3. تأكد من أن المسار صحيح في Firestore

## 🎨 تخصيص صفحة ولي الأمر

الصفحة موجودة في:
```
src/modules/guardian/pages/guardian-leave-request-page.tsx
```

يمكنك تعديل:
- تصميم الواجهة
- النصوص والرسائل
- منطق التحقق من الموقع (Geofence)
- شروط الحظر

## 🔐 ميزات الأمان المدمجة

صفحة ولي الأمر تتضمن:

1. **التحقق من الموقع الجغرافي (Geofence)**
   - يمنع الطلب إذا كان ولي الأمر بعيداً عن المدرسة
   - يمكن تعطيله من الإعدادات

2. **نظام الحظر**
   - يحظر ولي الأمر بعد عدد معين من المخالفات
   - المخالفة: عدم الالتزام بالمسافة المحددة

3. **منع الازدواجية**
   - لا يمكن إنشاء أكثر من طلب واحد لنفس الطالب في نفس الوقت

## 📱 الاستخدام على الهاتف

الصفحة متجاوبة تماماً ويمكن استخدامها من:
- الهاتف المحمول
- التابلت
- الكمبيوتر

للاختبار على الهاتف:
1. تأكد أن الهاتف والكمبيوتر على نفس الشبكة
2. احصل على IP المحلي للكمبيوتر:
   ```powershell
   ipconfig | Select-String "IPv4"
   ```
3. على الهاتف، افتح:
   ```
   http://192.168.x.x:5173/guardian/leave-request
   ```
   (استبدل `192.168.x.x` بالـ IP الفعلي)

## 🔄 تدفق البيانات الكامل

```
1. ولي الأمر يضغط "طلب استلام"
   ↓
2. يتم التحقق من:
   - ✅ هل ولي الأمر محظور؟
   - ✅ هل الموقع ضمن المسافة المسموحة؟
   - ✅ هل يوجد طلب نشط للطالب؟
   ↓
3. إنشاء وثيقة في Firestore:
   schools/{schoolId}/autoCallQueue/{randomId}
   ↓
4. AutoCallProvider يستمع للتغييرات (onSnapshot)
   ↓
5. تحديث شاشة العرض وصفحة الإدارة فوراً
   ↓
6. بعد المدة المحددة، يتم النداء مرة أخرى
   ↓
7. عند التأكيد من الإدارة، ينتقل الطلب إلى History
```

## 🚀 نصائح للتجربة

1. **افتح عدة تبويبات:**
   - ولي أمر + شاشة عرض + إدارة
   - هكذا ترى التحديثات اللحظية في كل مكان

2. **جرب سيناريوهات مختلفة:**
   - إضافة عدة طلبات متتالية
   - إلغاء طلب من صفحة الإدارة
   - تأكيد استلام طالب

3. **راقب Firestore Console:**
   - شاهد البيانات وهي تُضاف وتُحدث مباشرة
   - تعلّم بنية البيانات

4. **اختبر على أجهزة متعددة:**
   - هاتف + كمبيوتر في نفس الوقت
   - تأكد من التزامن الفوري

---

## 🎯 الخلاصة

**مسار ولي الأمر:**
```
http://localhost:5173/guardian/leave-request
```

**الخطوات:**
1. افتح المسار في المتصفح
2. اضغط "طلب استلام الطالب"
3. شاهد النتيجة في شاشة العرض وصفحة الإدارة

**للمساعدة:**
- راجع `FIRESTORE_QUICK_START.md` لإعداد Firebase
- راجع `FIREBASE_SETUP_GUIDE.md` للتفاصيل الكاملة
- تحقق من Console في المتصفح للأخطاء
